= javascript_include_tag 'account_mgmt'

- content_for :h1 do
  =h current_facility

- content_for :sidebar do
  = render :partial => 'admin/shared/sidenav_billing', :locals => { :sidenav_tab => 'purchase_orders' }

%h2 Manage Purchase Orders

- unless @accounts.empty?
  - form_tag(purchase_orders_facility_accounts_path, :method => :get) do
    %p
      = select_tag :selected_account, @accounts.collect{|a| "<option value=\"#{a.id}\"#{a == @selected ? ' selected="selected"' : ''}>#{a.to_s}</option>" }.join('')

  - if @selected.owner_user
    %h3= "Owner: #{@selected.owner_user.full_name}"
  %h3= "Balance: #{number_to_currency(@selected.unreconciled_total(current_facility))}"

  %p Please review the following orders. Check those that are paid, record any notes, and click 'Reconcile'.

  - form_tag(update_purchase_orders_facility_accounts_path, :method => :post) do
    %table
      %tr.borderless
        %td{:align => :left}
          =check_box_tag('toggle', '1', true, :class => 'left')
          %label{:for => 'toggle'} All
        %td
        %td
        %td{:align => :right}= submit_tag "Reconcile"
      %tr
        %th Paid?
        %th Description
        %th Amount
        %th Notes
      - @unreconciled_details.each do |od|
        %tr
          %td= check_box_tag("order_detail[#{od.id}][reconciled]", '1', true)
          %td
            %ul
              %li=h "#{od.description}: #{od.product.to_s}"
              - if od.note
                %li.indented
                  %i=h od.note

          %td= number_to_currency(od.actual_total)
          %td= text_field_tag "order_detail[#{od.id}][notes]", begin params[:order_detail][od.id.to_s][:notes] rescue '' end
      %tr.borderless
        %td
        %td
        %td
        %td{:align => :right}= submit_tag "Reconcile"

    %p= will_paginate(@unreconciled_details, :class => 'centered')
