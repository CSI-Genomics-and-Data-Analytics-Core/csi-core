- content_for :h1 do
  =h current_facility

- content_for :sidebar do
  = render :partial => 'admin/shared/sidenav_billing', :locals => { :sidenav_tab => 'journals' }

%h2 Manage Journals
%h3 Pending Journal
- if @pending_journal.nil?
  %p.notice There is no pending journal at this time
- else
  - form_for([current_facility, @pending_journal]) do |f|
    = f.error_messages 
    %table
      %tr
        %th Download
        %th Journaled On
        %th Amount
        %th
          %span.require Reference
        %th Notes
        %th
          %span.require Status
      %tr
        %td
          %ul
            %li=link_to 'XLS File', @pending_journal.file.url
            %li=link_to 'XML File', facility_journal_path(current_facility, @pending_journal, :format => 'xml')
        %td=h human_datetime(@pending_journal.created_at)
        %td=h number_to_currency(@pending_journal.amount)
        %td= f.text_field :reference
        %td= f.text_field :description
        %td
          = f.select :is_successful, {' ' => nil, 'Succeeded' => true, 'Failed' => false}
          = submit_tag "Close Journal"
%p
%hr
%p
%h3 Create Journal
- if @order_details.empty?
  %p.notice There are no orders to be journaled at this time
- else
  %p Select the orders that you wish to journal.  Only one journal may be pending at a time.  Please note that selected orders may not span multiple fiscal years.
  - disable = false
  - unless @pending_journal.nil?
    -disable = true
    %p.notice You may not generate a new journal until the pending journal is closed.
  - form_for(:journal, @journal, :path => facility_journals_path) do |f|
    = f.error_messages
    %table
      %tr.borderless
        %td{:colspan => 4}= disable ? '' : link_to('Select None', 'JavaScript:void(0);', :class => 'select_all')
        %td.currency{:colspan => 2}= submit_tag "Create Journal", {:disabled => disable}
      %tr
        %th
        %th Order
        %th Fulfilled On
        %th Account
        %th Owner
        %th.currency Total
      - @order_details.each do |od|
        - account = od.account
        %tr
          %td= check_box_tag "order_detail_ids[]", od.id, (action_name == 'create' && !@update_order_details.collect{|uod| uod.id}.include?(od.id) ? false : true), {:disabled => disable, :class => 'toggle'}
          %td
            %ul
              %li== ##{od}: #{od.product}
              - unless od.note.blank?
                %li
                  %i= od.note
          %td= human_date od.fulfilled_at
          %td=h account
          %td=h account.owner_user.full_name
          %td.currency=h number_to_currency od.total
      %tr.borderless
        %td{:colspan => 4}
        %td.currency{:colspan => 2}= submit_tag "Create Journal", {:disabled => disable}
